<?xml version="1.0"?>
<project name="drftpd" basedir="." default="compile">

  <target name="all" depends="compile"/>

  <target name="init">
    <property name="sourceDir" value="src/"/>
    <property name="outputDir" value="classes/"/>

    <path id="classpath">
	  <fileset dir=".">
	    <include name="lib/*"/>
	  </fileset>
    </path>
  </target>


  <target name="clean" depends="init">
    <delete dir="${outputDir}" />
  </target>

  <target name="prepare" depends="init">
    <mkdir dir="${outputDir}" />
  </target>

  <target name="compile" depends="init, prepare">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" classpathref="classpath" debug="true" source="1.4">
      <exclude name="**/*Test.java"/>
    </javac>
    <rmic base="${outputDir}" debug="true" stubversion="1.2">
	  <include name="**/*Impl.class"/>
	  <classpath refid="classpath"/>
    </rmic>
    <copy todir="${outputDir}">
      <fileset dir="${sourceDir}">
        <include name="**/*.properties"/>
      </fileset>
    </copy>
  </target>
  
  <target name="tests" depends="init, prepare">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" debug="true" source="1.4">
      <classpath refid="classpath"/>
      <include name="**/*Test.java"/>
  	</javac>
    <junit printsummary="on" haltonfailure="yes">
      <classpath refid="classpath"/>
      <classpath path="${outputDir}"/>
      <batchtest>
      	<fileset dir="${outputDir}">
      	  <include name="**/*Test.class"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="slavejar">
    <jar destfile="slave.jar" basedir="classes">
      <manifest>
        <attribute name="Main-Class" value="net.sf.drftpd.slave.SlaveImpl" />
      </manifest>
      <include name="se/mog/io/**/*.class" />
      <include name="net/sf/drftpd/*" />
      <include name="net/sf/drftpd/slave/*" />
      <include name="net/sf/drftpd/remotefile/*" />
      <include name="net/sf/drftpd/master/RemoteSlave.class" />
      <include name="net/sf/drftpd/master/SlaveManager.class" />
      <include name="net/sf/drftpd/master/SlaveManagerImpl_Stub.class" />
      <!-- until we have lightweight LinkedRemoteFile -->
      <include name="net/sf/drftpd/master/*" />
      <include name="net/sf/drftpd/master/config/FtpConfig.class" />
    </jar>
    
    <zip destfile="slave.zip" basedir=".">
      <include name="slave.jar"/>
      <include name="slave.conf.dist"/>
      <include name="slave.sh" />
      <include name="slave.bat" />
      <zipfileset dir="." includes="lib/libFileSystem.so" fullpath="libFileSystem.so" />
      <zipfileset dir="." includes="lib/FileSystem.dll" fullpath="FileSystem.dll" />
    </zip>
  </target>
  
  <target name="dist" depends="compile">
    <zip destfile="drftpd-0.9.0.zip" >
      <zipfileset  prefix="drftpd-0.9.0" dir=".">
    	<include name="INSTALL.txt"/>
    	<include name="drftpd.conf.dist"/>
    	<include name="perms.conf.dist"/>
    	<include name="slaves.xml.dist"/>
        <include name="replacerformats.conf.dist"/>
    	<include name="irc.conf.dist"/>
    	<include name="slaves.dtd"/>
    	<include name="build.xml"/>
    	<include name="slave.bat"/>
    	<include name="slave.sh"/>
    	<include name="master.sh"/>
    	<include name="master.bat"/>
    	<include name="lib/*"/>
    	<include name="src/**"/>
    	<include name="classes/**"/>
    	<include name="ftp-data/text/**"/>
	  </zipfileset>
    </zip>
  </target>
  
</project>
