<?xml version="1.0"?>
<!-- $Id: build.xml,v 1.44 2004/11/03 13:36:57 zubov Exp $ -->
<project name="drftpd" basedir="." default="compile">

  <target name="all" depends="compile"/>

  <target name="init">
    <property name="sourceDir" value="src/"/>
    <property name="outputDir" value="classes/"/>

    <path id="classpath">
	  <fileset dir=".">
	    <include name="lib/*.jar"/>
	  </fileset>
    </path>
  </target>

  <target name="format" depends="init">
    <taskdef name="jalopy" classname="de.hunsicker.jalopy.plugin.ant.AntPlugin">
      <classpath>
        <fileset dir="jalopy/lib">
          <include name="*.jar" />
        </fileset>
      </classpath>
    </taskdef>
    <jalopy fileformat="unix"
      classpathref="classpath">
      <fileset dir="${sourceDir}">
        <include name="**/*.java" />
      </fileset>
    </jalopy>
  </target>

  <target name="clean" depends="init">
    <delete dir="${outputDir}" />
  </target>

  <target name="prepare" depends="init">
    <mkdir dir="${outputDir}" />
  </target>

  <target name="compile-jfreechart" depends="compile">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" classpathref="classpath" debug="true" source="1.4">
      <include name="org/drftpd/friendly/**"/>
    </javac>
  </target>
  <target name="compile-jsx" depends="compile">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" classpathref="classpath" debug="true" source="1.4">
      <include  name="net/sf/drftpd/master/usermanager/jsx/**"/>
    </javac>
  </target>
  <target name="compile" depends="init, prepare">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" classpathref="classpath" debug="true" source="1.4">
      <exclude name="**/*Test.java"/>
      <exclude name="org/drftpd/friendly/**"/>
      <exclude name="net/sf/drftpd/master/usermanager/jsx/**"/>
    </javac>
    <copy todir="${outputDir}">
      <fileset dir="${sourceDir}">
        <include name="**/*.properties"/>
      </fileset>
    </copy>
    <echo>Additional important compile targets are: compile-jsx</echo>
  </target>

  <target name="compile-junit" depends="init, prepare">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" debug="true" source="1.4">
      <classpath refid="classpath"/>
      <include name="**/*Test.java"/>
  	</javac>
  </target>

  <target name="tests" depends="compile-junit">
    <junit printsummary="on" haltonfailure="yes">
      <classpath refid="classpath"/>
      <classpath path="${outputDir}"/>
      <batchtest>
      	<fileset dir="${outputDir}">
      	  <include name="**/*Test.class"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="slavejar">
    <jar destfile="slave.jar" basedir="classes">
      <manifest>
        <attribute name="Main-Class" value="org.drftpd.slave.Slave" />
      </manifest>
      <include name="se/mog/io/**/*.class" />
      <include name="net/sf/drftpd/*" />
      <include name="net/sf/drftpd/slave/*" />
      <include name="net/sf/drftpd/remotefile/*" />
      <include name="net/sf/drftpd/master/RemoteSlave.class" />
      <include name="net/sf/drftpd/master/SlaveManager.class" />
      <include name="net/sf/drftpd/util/SSLGetContext.class" />
      <include name="net/sf/drftpd/util/PortRange.class" />
      <include name="net/sf/drftpd/util/AddAsciiOutputStream.class" />
      <include name="net/sf/drftpd/util/ListUtils.class"/>
      <!-- until we have lightweight LinkedRemoteFile -->
      <include name="net/sf/drftpd/master/*" />
      <include name="net/sf/drftpd/master/config/FtpConfig.class" />
    </jar>
    
    <zip destfile="slave.zip" basedir=".">
      <include name="slave.jar"/>
      <include name="slave.conf.dist"/>
      <include name="slave.sh" />
      <include name="slave.bat" />
      <include name="conf/wrapper-slave.conf.dist"/>
      <zipfileset dir="." includes="lib/libFileSystem.so" fullpath="libFileSystem.so" />
      <zipfileset dir="." includes="lib/FileSystem.dll" fullpath="FileSystem.dll" />
    </zip>
  </target>

  <target name="classjar">
    <jar destfile="class.jar" basedir="classes">
      <manifest>
        <attribute name="Main-Class" value="net.sf.drftpd.master.ConnectionManager" />
      </manifest>
      <include name="**" />
    </jar>
  </target>

  <target name="dist" depends="compile">
    <fail unless="version">
      You need to specify version to build.
      Use argument -Dversion=0.11.0-CVS for example.
    </fail>
    <chmod dir="." perm="+x" includes="*.sh" />
    <chmod dir="." perm="+x" includes="bin/wrapper" />
    <patternset id="distfiles">
    	<include name="INSTALL.txt"/>
    	<include name="drftpd.conf.dist"/>
    	<include name="slave.conf.dist"/>
    	<include name="build.xml"/>
    	<include name="slave.bat"/>
    	<include name="slave.sh"/>
    	<include name="master.sh"/>
    	<include name="master.bat"/>
    	<include name="genkey.sh"/>
    	<include name="genkey.bat"/>
    	<include name="conf/*.dist" />
    	<include name="conf/log4j-*.properties" />
    	<include name="lib/*"/>
    	<include name="src/**"/>
    	<include name="classes/**"/>
    	<include name="ftp-data/text/**"/>
    	<include name="extsources/*"/>
    	<include name="bin/*"/>
    	<exclude name="src/org/drftpd/friendly/**"/>
    	<exclude name="classes/org/drftpd/friendly/**"/>
    </patternset>

    <tar destfile="drftpd-${version}.tar">
      <tarfileset prefix="drftpd-${version}" dir=".">
        <patternset refid="distfiles"/>
      </tarfileset>
    </tar>
    <gzip src="drftpd-${version}.tar" destfile="drftpd-${version}.tar.gz"/>

    <zip destfile="drftpd-${version}.zip">
      <zipfileset  prefix="drftpd-${version}" dir=".">
      <patternset refid="distfiles"/>
	  </zipfileset>
    </zip>
    <echo>
      Note that you need to update version number in
      src/org/drftpd/slave/Slave.java manually.
    </echo>
  </target>

</project>
