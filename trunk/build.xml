<?xml version="1.0"?>
<!-- $Id: build.xml,v 1.33 2004/02/05 19:38:51 mog Exp $ -->
<project name="drftpd" basedir="." default="compile">

  <target name="all" depends="compile"/>

  <target name="init">
    <property name="sourceDir" value="src/"/>
    <property name="outputDir" value="classes/"/>

    <path id="classpath">
	  <fileset dir=".">
	    <include name="lib/*"/>
	  </fileset>
    </path>
  </target>

  <target name="clean" depends="init">
    <delete dir="${outputDir}" />
  </target>

  <target name="prepare" depends="init">
    <mkdir dir="${outputDir}" />
  </target>

  <target name="compile" depends="init, prepare">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" classpathref="classpath" debug="true" source="1.4">
      <exclude name="**/*Test.java"/>
    </javac>
    <rmic base="${outputDir}" debug="true" stubversion="1.2">
	  <include name="**/*Impl.class"/>
	  <classpath refid="classpath"/>
    </rmic>
    <copy todir="${outputDir}">
      <fileset dir="${sourceDir}">
        <include name="**/*.properties"/>
      </fileset>
    </copy>
  </target>
  
  <target name="tests" depends="init, prepare">
    <javac srcdir="${sourceDir}" destdir="${outputDir}" debug="true" source="1.4">
      <classpath refid="classpath"/>
      <include name="**/*Test.java"/>
  	</javac>
    <junit printsummary="on" haltonfailure="yes">
      <classpath refid="classpath"/>
      <classpath path="${outputDir}"/>
      <batchtest>
      	<fileset dir="${outputDir}">
      	  <include name="**/*Test.class"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="slavejar">
    <jar destfile="slave.jar" basedir="classes">
      <manifest>
        <attribute name="Main-Class" value="net.sf.drftpd.slave.SlaveImpl" />
      </manifest>
      <include name="se/mog/io/**/*.class" />
      <include name="net/sf/drftpd/*" />
      <include name="net/sf/drftpd/slave/*" />
      <include name="net/sf/drftpd/remotefile/*" />
      <include name="net/sf/drftpd/master/RemoteSlave.class" />
      <include name="net/sf/drftpd/master/SlaveManager.class" />
      <include name="net/sf/drftpd/master/SlaveManagerImpl_Stub.class" />
      <include name="net/sf/drftpd/util/SSLGetContext.class" />
      <include name="net/sf/drftpd/util/PortRange.class" />
      <include name="net/sf/drftpd/util/AddAsciiOutputStream.class" />
      <!-- until we have lightweight LinkedRemoteFile -->
      <include name="net/sf/drftpd/master/*" />
      <include name="net/sf/drftpd/master/config/FtpConfig.class" />
    </jar>
    
    <zip destfile="slave.zip" basedir=".">
      <include name="slave.jar"/>
      <include name="slave.conf.dist"/>
      <include name="slave.sh" />
      <include name="slave.bat" />
      <zipfileset dir="." includes="lib/libFileSystem.so" fullpath="libFileSystem.so" />
      <zipfileset dir="." includes="lib/FileSystem.dll" fullpath="FileSystem.dll" />
    </zip>
  </target>

  <target name="dist" depends="compile">
    <fail unless="version">
      You need to specify version to build.
      Use argument -Dversion=0.11.0-CVS for example.
    </fail>
    <chmod dir="." perm="+x" includes="*.sh" />
    <chmod dir="." perm="+x" includes="bin/wrapper" />
    <patternset id="distfiles">
    	<include name="INSTALL.txt"/>
    	<include name="drftpd.conf.dist"/>
    	<include name="slave.conf.dist"/>
    	<include name="build.xml"/>
    	<include name="slave.bat"/>
    	<include name="slave.sh"/>
    	<include name="master.sh"/>
    	<include name="master.bat"/>
    	<include name="conf/*.dist" />
    	<include name="lib/*"/>
    	<include name="src/**"/>
    	<include name="classes/**"/>
    	<include name="ftp-data/text/**"/>
    	<include name="extsources/*"/>
    	<include name="bin/*"/>
    </patternset>

    <tar destfile="drftpd-${version}.tar">
      <tarfileset prefix="drftpd-${version}" dir=".">
        <patternset refid="distfiles"/>
      </tarfileset>
    </tar>
    <gzip src="drftpd-${version}.tar" destfile="drftpd-${version}.tar.gz"/>

    <zip destfile="drftpd-${version}.zip">
      <zipfileset  prefix="drftpd-${version}" dir=".">
      <patternset refid="distfiles"/>
	  </zipfileset>
    </zip>
  </target>

</project>
